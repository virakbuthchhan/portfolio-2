// PostgreSQL datasource
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ────────────────────────────────────────
// ENUMS
// ────────────────────────────────────────

enum Role {
  ADMIN
  ATTENDEE
}

enum EventStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
}

enum NotificationType {
  EMAIL
  SMS
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

// ────────────────────────────────────────
// CORE TABLES
// ────────────────────────────────────────

model User {
  @@map("users")
  id         String   @id @default(uuid())
  email      String?  @unique
  fullName   String   @map("full_name")
  phone      String?  @unique
  employeeId String?  @unique @map("employee_id")
  role       Role     @default(ATTENDEE)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Foreign keys to setup tables
  genderId       String? @map("gender_id")
  positionId     String? @map("position_id")
  departmentId   String? @map("department_id")
  organizationId String? @map("organization_id")

  // Relations
  gender       Gender?       @relation(fields: [genderId], references: [id])
  position     Position?     @relation(fields: [positionId], references: [id])
  department   Department?   @relation(fields: [departmentId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])

  // Events organized
  organizedEvents Event[] @relation("EventOrganizer")

  // Event attendance
  eventAttendances EventAttendee[]

  // Notifications
  notifications Notification[]

  // Activity logs
  logs ActivityLog[]

  // User-specific settings (optional)
  settings Setting[]
}

model Event {
  @@map("events")
  id          String      @id @default(uuid())
  code        String      @unique
  title       String
  description String?
  date        DateTime
  location    String?
  status      EventStatus @default(DRAFT)
  visibility  Visibility  @default(PUBLIC)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])
  // Organizer (admin who created it)
  organizerId  String      @map("organizer_id")
  organizer    User        @relation("EventOrganizer", fields: [organizerId], references: [id])

  // Attendees
  attendees EventAttendee[]

  // Logs
  logs ActivityLog[]

  // Optional: link to template
  templateId String?        @map("template_id")
  template   EventTemplate? @relation(fields: [templateId], references: [id])
}

model EventAttendee {
  @@map("event_attendees")
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  eventId   String           @map("event_id")
  isInvited Boolean          @default(false) @map("is_invited")
  status    AttendanceStatus @default(PENDING)
  signature String? // "confirmed" or base64 image
  joinedAt  DateTime?        @map("joined_at") // null until check-in

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@unique([userId, eventId])
}

// ────────────────────────────────────────
// DATA SETUP TABLES
// ────────────────────────────────────────

model Gender {
  @@map("genders")
  id    String @id @default(uuid())
  name  String @unique
  users User[]
}

model Position {
  @@map("positions")
  id    String @id @default(uuid())
  name  String @unique
  users User[]
}

model Department {
  @@map("departments")
  id    String @id @default(uuid())
  name  String @unique
  users User[]

  // Reverse relation: templates associated with this department
  eventTemplates EventTemplate[]
  // events associated with this department
  events         Event[]
}

model Organization {
  @@map("organizations")
  id    String @id @default(uuid())
  name  String @unique
  users User[]
}

// ────────────────────────────────────────
// EVENT TEMPLATES (for recurring formats)
// ────────────────────────────────────────

model EventTemplate {
  @@map("event_templates")
  id              String      @id @default(uuid())
  name            String      @unique
  defaultTitle    String      @map("default_title")
  defaultLocation String?     @map("default_location")
  description     String?
  departmentId    String?     @map("department_id")
  department      Department? @relation(fields: [departmentId], references: [id])
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Reverse relation: events created from this template
  events Event[]
}

// ────────────────────────────────────────
// NOTIFICATIONS
// ────────────────────────────────────────

model Notification {
  @@map("notifications")
  id        String             @id @default(uuid())
  userId    String             @map("user_id")
  title     String
  message   String
  type      NotificationType   @default(IN_APP)
  status    NotificationStatus @default(PENDING)
  sentAt    DateTime?          @map("sent_at")
  readAt    DateTime?          @map("read_at")
  metadata  Json? // e.g., { email: "...", smsProvider: "twilio" }
  createdAt DateTime           @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])
}

// ────────────────────────────────────────
// SETTINGS (system-wide or per-user)
// ────────────────────────────────────────

model Setting {
  @@map("settings")
  id     String  @id @default(uuid())
  key    String // e.g., "require_signature", "default_language", "qr_timeout_minutes"
  value  String
  userId String? @map("user_id") // if null → system-wide; if set → user-specific

  user User? @relation(fields: [userId], references: [id])

  @@unique([key, userId]) // allow one setting per key per user (or global)
}

// ────────────────────────────────────────
// ACTIVITY LOGGING
// ────────────────────────────────────────

model ActivityLog {
  @@map("activity_logs")
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  eventId   String?  @map("event_id")
  action    String // e.g., "event.created", "attendance.confirmed", "user.login"
  details   Json? // structured extra data
  ip        String?
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  user  User?  @relation(fields: [userId], references: [id])
  event Event? @relation(fields: [eventId], references: [id])
}
